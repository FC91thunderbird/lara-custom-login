<div class="row" id="basic-table">
    <div class="col-12">
        <div class="card">
            <div class="card-header">

                <?php 
                if($msg = $this->session->flashdata('msg')){ ?>
                    <div class="alert alert-danger">
                        <?= $msg ?>
                    </div>
                <?php } ?>
                <h4 class="card-title">Api Panel</h4>
                <button id="add_button">Add Api</button>
            </div>
            <div class="table-responsive">
            <span id="success_message"></span>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Firstname</th>
                            <th>Lastname</th>
                            <th>Edit</th>
                            <th>Delete</th>
                        </tr>
                    </thead>
                    <tbody id="showid">


                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>



<div id="userModal" class="modal fade">
    <div class="modal-dialog">
        <form method="post" id="user_form">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Add User</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <label>Enter First Name</label>
                    <input type="text" name="first_name" id="first_name" class="form-control" />
                    <span id="first_name_error" class="text-danger"></span>
                    <br />
                    <label>Enter Last Name</label>
                    <input type="text" name="last_name" id="last_name" class="form-control" />
                    <span id="last_name_error" class="text-danger"></span>
                    <br />
                </div>
                <div class="modal-footer">
                    <input type="hidden" name="id" id="user_id" />
                    <input type="hidden" name="data_action" id="data_action" value="Insert" />
                    <!-- <input type="submit" name="action" id="action" class="btn btn-success" value="Add" /> -->
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script type="text/javascript" language="javascript" >

// $(document).ready(function(){
    $(window).on("load",function(){

    function fetch_data(){
        $.ajax({
            url:"<?php echo base_url('api/fetchall') ?>",
            method:"get",
            async:false,
        dataType:'json',
            // data:
            success:function(data){
                // console.log(data)
            var html='';
            var i; 
            for(i=0;i<data.length;i++)
            {
                html+='<tr>'+
                        '<td>'+data[i].first_name+'</td>'+
                        '<td>'+data[i].last_name+'</td>'+
                        '<td>'+'<button type="button" name="edit" class="btn btn-warning btn-xs edit" id='+data[i].id+'>Edit</button>'+'</td>'+    
                        '<td>'+'<button type="button" name="delete" class="btn btn-danger btn-xs delete" id='+data[i].id+'>Delete</button>'+'</td>'+
                    '</tr>'; 
            }
            $("#showid").html(html); 
        },
        error:function(data)
        {
            alert('ajax error'); 
        }

           
        })
    }

    fetch_data();

    $('#add_button').click(function(){
        $('#user_form')[0].reset();
        $('.modal-title').text("add user");
        $("#action").val('Insert Form');
        $('#userModal').modal('show');
        $('#data_action').val('Insert');
    });


    $(document).on('submit','#user_form', function(e){
        e.preventDefault();

        if($('#data_action').val()==='Insert'){
            var mainUrl = "<?= base_url('api/insert') ?>";
        }else{
            var mainUrl = "<?= base_url('api/update') ?>";
        }

        $.ajax({
            url: mainUrl,
            method:"POST",
            data:$(this).serialize(),
            dataType:"json",

            success:function(data){
                if(data.success){
                    $('#user_form')[0].reset();
                    $('#userModal').modal('hide');
                    fetch_data();

                    if($('#data_action').val()=='Insert'){
                        $('#success_message').html('<div class="alert alert-success p-1 m-1"> Successful insert</div>');
                    }else{
                        $('#success_message').html('<div class="alert alert-success p-1 m-1"> Update Successfully..</div>');
                    }
                }
                if(data.error){
                    $('#first_name_error').html(data.first_name_error);
                    $('#last_name_error').html(data.last_name_error);
                }
            }
        })
    });

    $(document).on('click','.edit',function(){
        var user_id = $(this).attr('id');
       
        $.ajax({
            url:"<?= base_url('api/fetch_single') ?>",
            method:"POST",
            data:{id:user_id},
            dataType:"json",
            success:function(data){
                $('#first_name_error').html('');
                $('#last_name_error').html('');

                $('#userModal').modal('show');
                $('#first_name').val(data.firstname);
                $('#last_name').val(data.lastname);
                $('#user_id').val(data.id);
                $('.modal-title').text('edit data');
                $('#action').val('Edit');
                $('#data_action').val('Edit');
            }

        })
    });

    $(document).on('click','.delete',function(){
        var user_id = $(this).attr('id');
        
        if(confirm("Are you want to delete?")){
            $.ajax({
                url:"<?= base_url('api/delete') ?>",
                method:"POST",
                data:{id:user_id},
                dataType:"json",
                success:function(data){
                    if(data.success){
                        $('#success_message').html('<div class="alert alert-success p-1 m-1">Data Deleted</div>');
                        fetch_data();
                    }
                }
            })
        }
    });

    // $.get("<?php echo base_url('api/fetchall') ?>", function (data) {

    // var result = JSON.parse(data);

    // console.log(data)


    // $.each(result, function (i, item) {
    //     // console.log(item)
    //     $('#showid').append('<tr><td>' + item.first_name + '</td><td>' + item.last_name + '</td></tr>');
    // });
    // });

});

</script>
